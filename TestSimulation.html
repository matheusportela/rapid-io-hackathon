<html>
		<head>
				<script src="http://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
				<script src="https://unpkg.com/rapid-io/dist/rapid.umd.js"></script>
				<script>
				// Simulation parameters
				const NUM_GATES = 3;
				const FLIGHT_INTERVAL_SECS = 10;
				const NUM_LUGGAGE_PER_PLANE = 50;
				const LUGGAGE_DEVIATION = 0.1
				const NUM_CARTS = 3;
				const NUM_LUGGAGE_PER_CART = 10;
				const CART_INTERVAL_SECS = 1;

				// Rapid.io collections
				const client = Rapid.createClient('NDA1OWE0MWo1b3AzY2U1LnJhcGlkLmlv')
				const luggages = client.collection('luggages')
				const flights = client.collection('flights')
				const carts = client.collection('carts')

				// Statistics
				var totalDepartures = 0;
				var totalLuggage = 0;

				var gates = []
				for (var i = 0; i < NUM_GATES; i++) {
					gates.push({free: true, luggage: 0})
				}
				</script>
		</head>
		<body>
			<div>
				<ul style="list-style-type:none">
					<li><button type="button" onclick="start()">Start Simulation</button></li>
					<li><button type="button" onclick="end()">End Simulation</button></li>
					<li><button type="button" onclick="deleteAll()">Delete All</button></li>
				</ul>
				<p id="stats"></p>
				<ul style="list-style-type:none">
					<li><p id="gate0"></p></li>
					<li><p id="gate1"></p></li>
					<li><p id="gate2"></p></li>
				</ul>
			</div>
				<script>
				function start() {
					initializeCarts()

					checkGate()
					selectGate()
					mainScript = setInterval(function() { checkGate() }, FLIGHT_INTERVAL_SECS*1000);
					carScript = setInterval(function() { selectGate() }, CART_INTERVAL_SECS*1000);
				}

				function initializeCarts() {
					for (var i = 0; i < NUM_CARTS; i++) {
					carts
						.document('V' + i)
						.mutate({
							cartId: i,
							status: 'Idle',
							bags_unloaded: 0
						})
						.then(
							() => console.log('Carts initialized'),
							err => console.log(err.type)
						)
					}
				}

				function checkGate() {
					for (var i = 0; i < NUM_GATES; i++) {
						if (gates[i].free) {
							createDeparture(i);
							gates[i].free = false;
						}
					}
				}

				function createDeparture(gate) {
					totalDepartures++;
					flightId = 'F' + totalDepartures;
					flights
						.document(flightId)
						.mutate({
							flightNumber: flightId,
							gate: gate,
							items: 0,
							status: 'waiting',
							type: 'departure',
							destination: 'JFK',
							arrival: totalDepartures*30
						})
						.then(
							() => console.log('Departure created'),
							err => console.log(err.type)
						)

					createLuggage(gate);
				}

				function createLuggage(gate) {
					numberOfBags = getRandomInt(NUM_LUGGAGE_PER_PLANE*(1.0 - LUGGAGE_DEVIATION), NUM_LUGGAGE_PER_PLANE*(1.0 + LUGGAGE_DEVIATION));

					for (var i = 0; i < numberOfBags; i++) {
						totalLuggage++
						luggageId = 'L' + totalLuggage
						luggages
							.document(luggageId)
							.mutate({
								id: luggageId,
								status: 'waiting',
								gate: gate,
								destination: 'SFO',
							})
							.then(
								() => console.log('Luggage created'),
								err => console.log(err.type)
							)
					}
				}

				function deleteDeparture() {
					for (var i = 0; i < 10; i++) {
						flights
							.document('F' + i)
							.delete({ timeout: 10000 })
							.then(
								() => console.log('Departure deleted'),
								err => console.log(err.type)
							)
					}
				}

				function deleteLuggage() {
					for (var i = 0; i < 100; i++) {
						luggages
							.document('L' + i)
							.delete({ timeout: 10000 })
							.then(
								() => console.log('Luggage deleted'),
								err => console.log(err.type)
							)
					}
				}

				function deleteAll(){
					deleteDeparture();
					deleteLuggage();
				}

				function getRandomInt(min, max) {
					return Math.floor(Math.random() * (max - min + 1)) + min;
				}

				function selectGate() {
					if (gates[0].luggage >= gates[1].luggage && gates[0].luggage >= gates[2].luggage) {
						deployCarts(0, 1, 2);
					} else if (gates[0].luggage <= gates[1].luggage && gates[0].luggage >= gates[2].luggage) {
						deployCarts(1, 0, 2);
					} else if (gates[0].luggage <= gates[1].luggage && gates[0].luggage <= gates[2].luggage) {
						deployCarts(1, 2, 0);
					} else if (gates[0].luggage >= gates[1].luggage && gates[0].luggage <= gates[2].luggage) {
						deployCarts(0, 2, 1);
					} else if (gates[2].luggage >= gates[1].luggage && gates[1].luggage >= gates[0].luggage) {
						deployCarts(2, 1, 0);
					} else {
						deployCarts(2, 0, 1);
					}
				}

				function deployCarts(primary, secondary, tertiary) {
					deployCart('V1', primary, gates[0].luggage)
					removeBags(primary);
					deployCart('V2', secondary, gates[1].luggage)
					removeBags(secondary);
					deployCart('V3', tertiary, gates[2].luggage)
					removeBags(tertiary);
				}

				function deployCart(cartId, gate, newLuggage) {
					if (gates[gate].luggage == 0)
						return;

					carts
						.document(cartId)
						.merge({
							status: 'Assigned to gate ' + gate,
							bags_unloaded: (gates[gate].luggage += newLuggage)
						})
						.then(
							() => console.log('Cart deployed'),
							err => console.log(err.type)
						)
					removeBags(gate);
				}

				function removeBags(gate) {
					luggages
						.filter({gate: gate})
						.fetch(messages => {
							for (var i = 0; i < NUM_LUGGAGE_PER_CART && i < messages.length; i++) {
								luggages
									.document(messages[i].id)
									.delete({ timeout: 10000 })
									.then(
										() => console.log('Bags removed'),
										err => console.log(err.type)
									)
							}
							gates[gate].luggage -= NUM_LUGGAGE_PER_CART;
							if (gates[gate].luggage < 0)
								gates[gate].luggage = 0;
						});

					if (gates[gate].luggage = 0) {
						flights
							.filter({ gate: gate })
							.fetch(messages => {
								messages.forEach(message =>
									flights
										.document(message.id)
										.delete({ timeout: 10000 })
								)
							});

						gates[i].free = true;
					}
				}

				function end() {
					clearInterval(mainScript);
					clearInterval(carScript);

					for(var i = 0; i < NUM_GATES; i++)
						gates[i].free = true;

					document.getElementById('stats').innerHTML = ('Total Planes: ' + totalDepartures + '\nTotal Bags: ' + totalLuggage);
				}
				</script>
		</body>
</html>
